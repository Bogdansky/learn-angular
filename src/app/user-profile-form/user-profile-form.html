<div class="user-profile-wizard">
  <!-- Header with Go Home link -->
  <div class="wizard-header">
    <h1>User Profile Wizard</h1>
    <a mat-button color="primary" (click)="onGoHome()" class="go-home-link">
      <mat-icon>home</mat-icon>
      Go Home
    </a>
  </div>

  <form [formGroup]="userProfileForm" (ngSubmit)="onSubmit()">
    <mat-stepper #stepper>
      
      <!-- Step 1: General Information -->
      <mat-step label="General Information">
        <div formGroupName="generalInfo" class="step-content">
          <h2>General Information</h2>
          
          <div class="form-row">
            <mat-form-field appearance="outline" class="full-width" hideRequiredMarker>
              <mat-label>Name</mat-label>
              <input matInput formControlName="name" required>
              @if (shouldShowError('generalInfo', 'name', 'required')) {
                <mat-error>
                  Name is required
                </mat-error>
              }
            </mat-form-field>
          </div>

          <div class="form-row">
            <mat-form-field appearance="outline" class="full-width" hideRequiredMarker>
              <mat-label>Surname</mat-label>
              <input matInput formControlName="surname" required>
              @if (shouldShowError('generalInfo', 'surname', 'required')) {
                <mat-error>
                  Surname is required
                </mat-error>
              }
            </mat-form-field>
          </div>

          <div class="form-row">
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Middle Name</mat-label>
              <input matInput formControlName="middleName">
            </mat-form-field>
          </div>

          <div class="form-row">
            <mat-form-field appearance="outline" class="full-width" hideRequiredMarker>
              <mat-label>Date of Birth</mat-label>
              <input matInput [matDatepicker]="birthDatePicker" formControlName="dateOfBirth" required>
              <mat-hint>MM/DD/YYYY</mat-hint>
              <mat-datepicker-toggle matIconSuffix [for]="birthDatePicker"></mat-datepicker-toggle>
              <mat-datepicker #birthDatePicker></mat-datepicker>
              @if (shouldShowError('generalInfo', 'dateOfBirth', 'required')) {
                <mat-error>
                  Date of birth is required
                </mat-error>
              }
            </mat-form-field>
          </div>

          <div class="form-row">
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Gender</mat-label>
              <mat-select formControlName="gender">
                @for (gender of genderOptions; track gender) {
                  <mat-option [value]="gender">
                    {{ gender | titlecase }}
                  </mat-option>
                }
              </mat-select>
            </mat-form-field>
          </div>

          <div class="step-actions">
            <button mat-raised-button color="primary" matStepperNext>
              Next
            </button>
          </div>
        </div>
      </mat-step>

      <!-- Step 2: Addresses -->
      <mat-step label="Addresses">
        <div class="step-content">
          <h2>Addresses</h2>
          <p>Please provide information about places where you have lived or are currently living.</p>

          <div formArrayName="addresses">
            @for (address of addressesFormArray.controls; track address; let i = $index) {
              <div [formGroupName]="i" class="address-section">
              
              <div class="section-header">
                <h3>Address {{ i + 1 }}</h3>
                <button type="button" mat-icon-button color="warn" 
                        (click)="removeAddress(i)" 
                        [disabled]="addressesFormArray.length === 1">
                  <mat-icon>delete</mat-icon>
                </button>
              </div>

              <div class="form-row">
                <mat-form-field appearance="outline" class="half-width" hideRequiredMarker>
                  <mat-label>Country</mat-label>
                  <mat-select formControlName="country" required>
                    @if (!(countries$ | async)) {
                      <mat-option disabled value="">
                        Loading countries...
                      </mat-option>
                    }
                    @for (country of countries$ | async; track country) {
                      <mat-option [value]="country.isoCode">
                        {{ country.displayName }}
                      </mat-option>
                    }
                  </mat-select>
                  @if (shouldShowAddressError(i, 'country', 'required')) {
                    <mat-error>
                      Country is required
                    </mat-error>
                  }
                </mat-form-field>

                <mat-form-field appearance="outline" class="half-width" hideRequiredMarker>
                  <mat-label>Region</mat-label>
                  <input matInput formControlName="region" required>
                  @if (shouldShowAddressError(i, 'region', 'required')) {
                    <mat-error>
                      Region is required
                    </mat-error>
                  }
                </mat-form-field>
              </div>

              <div class="form-row">
                <mat-form-field appearance="outline" class="full-width" hideRequiredMarker>
                  <mat-label>City</mat-label>
                  <input matInput formControlName="city" required>
                  @if (shouldShowAddressError(i, 'city', 'required')) {
                    <mat-error>
                      City is required
                    </mat-error>
                  }
                </mat-form-field>
              </div>

              <div class="form-row">
                <mat-form-field appearance="outline" class="full-width" hideRequiredMarker>
                  <mat-label>Street</mat-label>
                  <input matInput formControlName="street" required>
                  @if (shouldShowAddressError(i, 'street', 'required')) {
                    <mat-error>
                      Street is required
                    </mat-error>
                  }
                </mat-form-field>
              </div>

              <div class="form-row">
                <mat-form-field appearance="outline" class="half-width" hideRequiredMarker>
                  <mat-label>Building</mat-label>
                  <input matInput formControlName="building" required>
                  @if (shouldShowAddressError(i, 'building', 'required')) {
                    <mat-error>
                      Building is required
                    </mat-error>
                  }
                </mat-form-field>

                <mat-form-field appearance="outline" class="half-width">
                  <mat-label>Apartment</mat-label>
                  <input matInput formControlName="apartment">
                </mat-form-field>
              </div>
            </div>
            }
          </div>

          <button type="button" mat-raised-button color="accent" (click)="addAddress()" class="add-button">
            <mat-icon>add</mat-icon>
            Add Another Address
          </button>

          <div class="step-actions">
            <button mat-button matStepperPrevious>Back</button>
            <button mat-raised-button color="primary" matStepperNext>
              Next
            </button>
          </div>
        </div>
      </mat-step>

      <!-- Step 3: Employment History -->
      <mat-step label="Employment History">
        <div class="step-content">
          <h2>Employment History</h2>
          <p>Please provide information about your work experience.</p>

          <div formArrayName="employmentHistory">
            @for(employment of employmentHistoryFormArray.controls; track employment; let i = $index) {
                <div class="employment-section" [formGroupName]="i">
                    <div class="section-header">
                        <h3>Employment {{ i + 1 }}</h3>
                        <button type="button" mat-icon-button color="warn" 
                                (click)="removeEmployment(i)" 
                                [disabled]="employmentHistoryFormArray.length === 1">
                        <mat-icon>delete</mat-icon>
                        </button>
                    </div>

                    <div class="form-row">
                        <mat-form-field appearance="outline" class="full-width" hideRequiredMarker>
                        <mat-label>Employer</mat-label>
                        <input matInput formControlName="employer" required>
                        @if (shouldShowEmploymentError(i, 'employer', 'required')) {
                            <mat-error>
                                Employer is required
                            </mat-error>
                        }
                        </mat-form-field>
                    </div>

                    <div class="form-row">
                        <mat-form-field appearance="outline" class="half-width" hideRequiredMarker>
                        <mat-label>Start Date</mat-label>
                        <input matInput [matDatepicker]="startDatePicker" formControlName="dateOfStart" required>
                        <mat-hint>MM/DD/YYYY</mat-hint>
                        <mat-datepicker-toggle matIconSuffix [for]="startDatePicker"></mat-datepicker-toggle>
                        <mat-datepicker #startDatePicker></mat-datepicker>
                        @if(shouldShowEmploymentError(i, 'dateOfStart', 'required')) {
                            <mat-error>
                                Start date is required
                            </mat-error>
                        }
                        </mat-form-field>

                        <mat-form-field appearance="outline" class="half-width">
                        <mat-label>End Date</mat-label>
                        <input matInput [matDatepicker]="endDatePicker" formControlName="dateOfEnd"
                                [disabled]="employment.get('isStillEmployed')?.value">
                        <mat-hint>MM/DD/YYYY</mat-hint>
                        <mat-datepicker-toggle matIconSuffix [for]="endDatePicker"></mat-datepicker-toggle>
                        <mat-datepicker #endDatePicker></mat-datepicker>
                        @if(shouldShowEmploymentError(i, 'dateOfEnd', 'required')) {
                            <mat-error>
                                End date is required when not currently employed
                            </mat-error>
                        }
                        </mat-form-field>
                    </div>

                    <div class="form-row">
                        <mat-checkbox 
                        formControlName="isStillEmployed" 
                        class="still-employed-checkbox"
                        appMutuallyExclusiveCheckbox
                        [formArray]="employmentHistoryFormArray"
                        controlName="isStillEmployed"
                        relatedControlName="dateOfEnd">
                        Still working for this employer
                        </mat-checkbox>
                    </div>
                </div>
            }
          </div>

          <button type="button" mat-raised-button color="accent" (click)="addEmployment()" class="add-button">
            <mat-icon>add</mat-icon>
            Add Another Employment
          </button>

          <div class="step-actions">
            <button mat-button matStepperPrevious>Back</button>
            <button mat-raised-button color="primary" type="submit">
              Submit
            </button>
          </div>
        </div>
      </mat-step>

    </mat-stepper>
  </form>
</div>
